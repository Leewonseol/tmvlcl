import tkinter as tk
from tkinter import ttk, messagebox, scrolledtext
import json
import webbrowser # ì›¹ ë¸Œë¼ìš°ì €ë¥¼ ì—´ê¸° ìœ„í•œ ëª¨ë“ˆ
from datetime import datetime

# React ì½”ë“œì˜ moodOptions ì™€ ìœ ì‚¬í•œ í˜•íƒœë¡œ ì •ì˜
mood_options = ["ë§¤ìš°ë‚˜ì¨ ğŸ˜¢", "ë‚˜ì¨ ğŸ˜Ÿ", "ë³´í†µ ğŸ˜", "ì¢‹ìŒ ğŸ˜Š", "ë§¤ìš°ì¢‹ìŒ ğŸ˜„"]

class MoodJournalApp:
    def __init__(self, root_window):
        self.root = root_window
        self.root.title("ì˜¤ëŠ˜ì˜ í•˜ë£¨ ê¸°ë¡")
        # ì°½ í¬ê¸°ë¥¼ ë” ë„“ê²Œ ì„¤ì •í•˜ì—¬ ëª¨ë“  ë‚´ìš©ì„ ì˜ ë³´ì´ë„ë¡ í•¨
        self.root.geometry("750x850") 

        # ìƒíƒœ ë³€ìˆ˜ (Reactì˜ useStateì™€ ìœ ì‚¬í•œ ì—­í• )
        self.selected_mood = tk.StringVar()
        
        # Text ìœ„ì ¯ì˜ ë‚´ìš©ì„ ì €ì¥í•  ë³€ìˆ˜ë“¤ì€ ìœ„ì ¯ ìì²´ë¥¼ ì°¸ì¡°í•˜ì—¬ ê°€ì ¸ì˜´
        # ê° í…ìŠ¤íŠ¸ ì˜ì—­ì˜ placeholder í…ìŠ¤íŠ¸ ì •ì˜
        self.placeholders = {
            "today_description": "ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼, ëŠê¼ˆë˜ ê°ì •, ìƒê°ë“¤ì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”...",
            "support_evidence": "ì´ ê°ì •ì„ ë’·ë°›ì¹¨í•˜ëŠ” ì‚¬ì‹¤ë“¤ì„ ì ì–´ë³´ì„¸ìš”...",
            "opposing_evidence": "ê°ì •ì„ ë’·ë°›ì¹¨í•˜ëŠ” ì‚¬ì‹¤ë“¤ì— ë°˜ëŒ€ë˜ëŠ” ê´€ì ì„ ì ì–´ë³´ì„¸ìš”...",
            "new_conclusion": "ìœ„ì˜ ë¶„ì„ì„ í† ëŒ€ë¡œ ìƒˆë¡œìš´ ê´€ì ì´ë‚˜ ê²°ë¡ ì„ ì ì–´ë³´ì„¸ìš”...",
            "grateful_experience": "ì˜¤ëŠ˜ í•˜ë£¨ ì¤‘ ê°ì‚¬í–ˆë˜ ì¼, ê¸ì •ì ì¸ ê²½í—˜ì„ ì ì–´ë³´ì„¸ìš”...",
            "tomorrow_plan": "ë‚´ì¼ ë¬´ì—‡ì„ í• ì§€ ì ì–´ë³´ì„¸ìš”..."
        }

        self.create_gui_elements()

    def _create_labeled_text_area(self, parent_frame, label_text, placeholder_key, text_height=4):
        """ë°˜ë³µë˜ëŠ” ë ˆì´ë¸” + ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸ ì˜ì—­ ìƒì„± ë¶€ë¶„ì„ í•¨ìˆ˜ë¡œ ì¶”ì¶œ"""
        frame = ttk.Frame(parent_frame, padding=(0, 5)) # ë‚´ë¶€ ì—¬ë°± ì¡°ì •
        frame.pack(fill=tk.X, pady=2) # ì„¹ì…˜ ê°„ ìˆ˜ì§ ê°„ê²© ì¤„ì„
        
        label = ttk.Label(frame, text=label_text)
        label.pack(anchor=tk.W, pady=(0, 3)) # ë ˆì´ë¸”ê³¼ í…ìŠ¤íŠ¸ ì˜ì—­ ì‚¬ì´ ê°„ê²© ì¤„ì„
        
        text_area = scrolledtext.ScrolledText(frame, height=text_height, wrap=tk.WORD, font=("Arial", 10), relief=tk.SOLID, borderwidth=1)
        
        placeholder_text = self.placeholders[placeholder_key]
        text_area.insert(tk.END, placeholder_text)
        text_area.config(fg='grey') # Placeholder í…ìŠ¤íŠ¸ ìƒ‰ìƒ

        def on_focus_in(event, widget=text_area, placeholder=placeholder_text):
            if widget.get("1.0", tk.END).strip() == placeholder:
                widget.delete("1.0", tk.END)
                widget.config(fg='black')

        def on_focus_out(event, widget=text_area, placeholder=placeholder_text):
            if not widget.get("1.0", tk.END).strip():
                widget.insert("1.0", placeholder)
                widget.config(fg='grey')
        
        text_area.bind("<FocusIn>", on_focus_in)
        text_area.bind("<FocusOut>", on_focus_out)
        text_area.pack(fill=tk.X, expand=True)
        return text_area

    def create_gui_elements(self):
        # ì „ì²´ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ë©”ì¸ í”„ë ˆì„ê³¼ ìº”ë²„ìŠ¤ ì„¤ì •
        main_canvas_frame = ttk.Frame(self.root)
        main_canvas_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

        canvas = tk.Canvas(main_canvas_frame)
        scrollbar = ttk.Scrollbar(main_canvas_frame, orient="vertical", command=canvas.yview)
        scrollable_inner_frame = ttk.Frame(canvas)

        scrollable_inner_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )

        canvas.create_window((0, 0), window=scrollable_inner_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)

        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
        
        # --- í•´í”¼ íˆ¬ê²Œë”---
        app_title_frame = ttk.Frame(scrollable_inner_frame, style="Title.TFrame")
        app_title_frame.pack(fill=tk.X, pady=(0,15))
        
        title_label = ttk.Label(app_title_frame, text="ì˜¤ëŠ˜ì˜ í•˜ë£¨", font=("Arial", 20, "bold"), anchor="center")
        title_label.pack(pady=(5,2))
        subtitle_label = ttk.Label(app_title_frame, text="ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ì •ë¦¬í•˜ê³  ë‚´ì¼ì„ ê³„íší•´ë³´ì„¸ìš”", font=("Arial", 10), anchor="center")
        subtitle_label.pack()

        # --- 1. ì˜¤ëŠ˜ì˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”? ---
        mood_section = ttk.LabelFrame(scrollable_inner_frame, text="ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”?", padding="10")
        mood_section.pack(fill=tk.X, pady=7)

        mood_select_label = ttk.Label(mood_section, text="ê°ì • ì„ íƒ:")
        mood_select_label.pack(anchor=tk.W, pady=(0,5))
        
        mood_buttons_container = ttk.Frame(mood_section)
        mood_buttons_container.pack(fill=tk.X)

        for mood_text in mood_options:
            # ì‹¤ì œ ê°’ì€ ì´ëª¨í‹°ì½˜ ì œì™¸í•œ í…ìŠ¤íŠ¸ ë¶€ë¶„ë§Œ ì‚¬ìš©
            actual_mood_value = mood_text.split(" ")[0] 
            rb = ttk.Radiobutton(mood_buttons_container, text=mood_text, variable=self.selected_mood, value=actual_mood_value, style="TRadiobutton")
            rb.pack(side=tk.LEFT, padx=3, expand=True, fill=tk.X) # ë²„íŠ¼ë“¤ì´ ê³µê°„ì„ ê· ë“±í•˜ê²Œ ì°¨ì§€í•˜ë„ë¡
        
        self.today_description_text = self._create_labeled_text_area(mood_section, "ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ìì„¸íˆ ë“¤ë ¤ì£¼ì„¸ìš”:", "today_description", text_height=5)

        # --- 2. ê·¸ ê°ì •ì„ ì™œ ëŠê¼ˆì„ê¹Œìš”? ---
        analysis_section = ttk.LabelFrame(scrollable_inner_frame, text="ê·¸ ê°ì •ì„ ì™œ ëŠê¼ˆì„ê¹Œìš”?", padding="10")
        analysis_section.pack(fill=tk.X, pady=7)

        self.support_evidence_text = self._create_labeled_text_area(analysis_section, "ì§€ì§€ ê·¼ê±°:", "support_evidence", text_height=3)
        self.opposing_evidence_text = self._create_labeled_text_area(analysis_section, "ë°˜ëŒ€ ê·¼ê±°:", "opposing_evidence", text_height=3)
        self.new_conclusion_text = self._create_labeled_text_area(analysis_section, "ìƒˆë¡œìš´ ê²°ë¡ :", "new_conclusion", text_height=3)

        # --- 3. ê°ì‚¬í•œ ê²½í—˜ ---
        grateful_section = ttk.LabelFrame(scrollable_inner_frame, text="ê°ì‚¬í•œ ê²½í—˜", padding="10")
        grateful_section.pack(fill=tk.X, pady=7)
        self.grateful_experience_text = self._create_labeled_text_area(grateful_section, "ì˜¤ëŠ˜ ê°ì‚¬í–ˆë˜ ì¼ (ìµœì†Œ 1ê°œ):", "grateful_experience", text_height=3)

        # --- 4. ë‚´ì¼ì˜ í–‰ë™ ê³„íš ---
        plan_section = ttk.LabelFrame(scrollable_inner_frame, text="ë‚´ì¼ì˜ í–‰ë™ ê³„íš", padding="10")
        plan_section.pack(fill=tk.X, pady=7)
        self.tomorrow_plan_text = self._create_labeled_text_area(plan_section, "ê³„íš:", "tomorrow_plan", text_height=3)
        
        # --- ì œì¶œ ë²„íŠ¼ ---
        submit_button = ttk.Button(scrollable_inner_frame, text="ê¸°ë¡ ì™„ë£Œ", command=self.submit_journal_entry, style="Accent.TButton")
        submit_button.pack(pady=15)

        # --- ì „ë¬¸ê°€ ë° ì„¼í„° ì°¾ê¸° ë§í¬ ---
        self._create_info_links(scrollable_inner_frame)


    def _create_info_links(self, parent_frame):
        links_section = ttk.LabelFrame(parent_frame, text="ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?", padding="10")
        links_section.pack(fill=tk.X, pady=7)

        def create_link(frame, text, url):
            link_label = ttk.Label(frame, text=text, foreground="blue", cursor="hand2", font=("Arial", 9))
            link_label.pack(anchor=tk.W, pady=1)
            link_label.bind("<Button-1>", lambda e, link_url=url: webbrowser.open_new(link_url))

        expert_title = ttk.Label(links_section, text="ğŸ§  ë‚´ ì£¼ë³€ ì‹¬ë¦¬ìƒë‹´ ì „ë¬¸ê°€ ì°¾ê¸°", font=("Arial", 11, "bold"))
        expert_title.pack(anchor=tk.W, pady=(0,3))
        expert_links_data = [
            ("í•œêµ­ìƒë‹´ì‹¬ë¦¬í•™íšŒ ìƒë‹´ì‹¬ë¦¬ì‚¬ ì°¾ì•„ë³´ê¸°", "https://krcpa.or.kr/user/new/sub04_1new.asp"),
            ("í•œêµ­ìƒë‹´í•™íšŒ ì „ë¬¸ìƒë‹´ì‚¬ ì°¾ê¸°", "https://counselors.or.kr/KOR/user/find_counselors.php"),
            ("í•œêµ­ì„ìƒì‹¬ë¦¬í•™íšŒ ì„ìƒì‹¬ë¦¬ì „ë¬¸ê°€ ì¡°íšŒ", "https://www.kcp.or.kr/new/psychologistManagement/list.asp?listType=1"),
          
        ]
        for text, url in expert_links_data:
            create_link(links_section, text, url)

        center_title = ttk.Label(links_section, text="ğŸ¥ ë‚´ ì£¼ë³€ ì‹¬ë¦¬ìƒë‹´Â·ë³µì§€ì„œë¹„ìŠ¤ ì œê³µê¸°ê´€ ì°¾ê¸°", font=("Arial", 11, "bold"))
        center_title.pack(anchor=tk.W, pady=(8,3))
        center_links_data = [
            ("ë‚´ ê·¼ì²˜ ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„°", "https://www.mohw.go.kr/menu.es?mid=a10706040300"),
            ("ì „êµ­ë¯¼ ë§ˆìŒíˆ¬ì ì§€ì›ì‚¬ì—…Â·ë³µì§€ì„œë¹„ìŠ¤ ì œê³µê¸°ê´€ ì¡°íšŒ", "https://www.socialservice.or.kr:444/user/svcsrch/supply/supplyList.do")
        ]
        for text, url in center_links_data:
            create_link(links_section, text, url)

    def _get_text_or_empty(self, text_widget, placeholder_key):
        """í…ìŠ¤íŠ¸ ìœ„ì ¯ì—ì„œ ì‹¤ì œ ì…ë ¥ê°’ ë˜ëŠ” ë¹ˆ ë¬¸ìì—´ ë°˜í™˜"""
        content = text_widget.get("1.0", tk.END).strip()
        return "" if content == self.placeholders[placeholder_key] else content

    def submit_journal_entry(self):
        # ì…ë ¥ê°’ ìœ íš¨ì„± ê²€ì‚¬
        if not self.selected_mood.get():
            messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "ê¸°ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")
            return
        
        today_description = self._get_text_or_empty(self.today_description_text, "today_description")
        if not today_description:
            messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "ì˜¤ëŠ˜ í•˜ë£¨ ì´ì•¼ê¸°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            return

        new_conclusion = self._get_text_or_empty(self.new_conclusion_text, "new_conclusion")
        if not new_conclusion:
            messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "ìƒˆë¡œìš´ ê²°ë¡ ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            return
        
        grateful_experience = self._get_text_or_empty(self.grateful_experience_text, "grateful_experience")
        if not grateful_experience:
            messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "ê°ì‚¬í•œ ê²½í—˜ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            return

        tomorrow_plan = self._get_text_or_empty(self.tomorrow_plan_text, "tomorrow_plan")
        if not tomorrow_plan:
            messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "ë‚´ì¼ì˜ í–‰ë™ ê³„íšì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            return
            
        # ë°ì´í„° ê°ì²´ ìƒì„±
        journal_data = {
            "timestamp": datetime.now().isoformat(),
            "mood": self.selected_mood.get(),
            "todayDescription": today_description,
            "supportEvidence": self._get_text_or_empty(self.support_evidence_text, "support_evidence"),
            "opposingEvidence": self._get_text_or_empty(self.opposing_evidence_text, "opposing_evidence"),
            "newConclusion": new_conclusion,
            "gratefulExperience": grateful_experience,
            "tomorrowPlan": tomorrow_plan,
        }

        # ë°ì´í„°ë¥¼ JSON íŒŒì¼ì— ì €ì¥ (append ëª¨ë“œ)
        try:
            # ê¸°ì¡´ ë°ì´í„°ë¥¼ ì½ì–´ì˜¤ê±°ë‚˜ ìƒˆ ë¦¬ìŠ¤íŠ¸ ìƒì„±
            try:
                with open("mood_journal_log.json", "r", encoding="utf-8") as f:
                    all_entries = json.load(f)
                    if not isinstance(all_entries, list): # íŒŒì¼ ë‚´ìš©ì´ ë¦¬ìŠ¤íŠ¸ê°€ ì•„ë‹ˆë©´ ë¦¬ìŠ¤íŠ¸ë¡œ ì´ˆê¸°í™”
                        all_entries = []
            except (FileNotFoundError, json.JSONDecodeError):
                all_entries = []
            
            all_entries.append(journal_data) # ìƒˆ í•­ëª© ì¶”ê°€

            with open("mood_journal_log.json", "w", encoding="utf-8") as f:
                json.dump(all_entries, f, ensure_ascii=False, indent=2)
                
            messagebox.showinfo("ê¸°ë¡ ì™„ë£Œ", "ì˜¤ëŠ˜ì˜ í•˜ë£¨ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
            self.clear_all_fields()
        except Exception as e:
            messagebox.showerror("ì €ì¥ ì‹¤íŒ¨", f"ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")

    def clear_all_fields(self):
        """ëª¨ë“  ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”"""
        self.selected_mood.set("") # ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ í•´ì œ
        
        text_widget_map = {
            self.today_description_text: "today_description",
            self.support_evidence_text: "support_evidence",
            self.opposing_evidence_text: "opposing_evidence",
            self.new_conclusion_text: "new_conclusion",
            self.grateful_experience_text: "grateful_experience",
            self.tomorrow_plan_text: "tomorrow_plan",
        }
        
        for widget, placeholder_key in text_widget_map.items():
            placeholder_text = self.placeholders[placeholder_key]
            widget.config(fg='black') # ì„ì‹œë¡œ ìƒ‰ìƒ ë³€ê²½ í›„ ë‚´ìš© ì‚­ì œ
            widget.delete("1.0", tk.END)
            widget.insert("1.0", placeholder_text)
            widget.config(fg='grey') # Placeholder ìƒ‰ìƒìœ¼ë¡œ ë³µì›


if __name__ == "__main__":
    app_root = tk.Tk()
    
    # ìŠ¤íƒ€ì¼ ì„¤ì • (ì„ íƒì )
    style = ttk.Style()
    style.theme_use('clam') # 'clam', 'alt', 'default', 'classic' ë“± ì‚¬ìš© ê°€ëŠ¥

    style.configure("TLabel", font=("Arial", 10))
    style.configure("TRadiobutton", font=("Arial", 9))
    style.configure("TButton", font=("Arial", 10, "bold"), padding=5)
    style.configure("Accent.TButton", foreground="white", background="#007bff") # ì˜ˆì‹œ ê°•ì¡° ë²„íŠ¼
    style.configure("Title.TFrame") # ì œëª© ì˜ì—­ ë°°ê²½ìƒ‰ ë“± ì„¤ì • ê°€ëŠ¥
    style.configure("TLabelFrame.Label", font=("Arial", 11, "bold")) # LabelFrame ì œëª© ìŠ¤íƒ€ì¼

    journal_app = MoodJournalApp(app_root)
    app_root.mainloop()
